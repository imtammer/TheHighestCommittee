#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# Secrets Manager for Homelab Docker Stacks
# Uses SOPS + age for encryption - safe to commit encrypted files to git
# ═══════════════════════════════════════════════════════════════════════════════

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
STACKS_DIR="/opt/stacks"
SECRETS_DIR="${STACKS_DIR}/.secrets"
AGE_KEY_FILE="${SECRETS_DIR}/age-key.txt"
SOPS_CONFIG="${STACKS_DIR}/.sops.yaml"
MASTER_ENV="${STACKS_DIR}/.env"
ENCRYPTED_ENV="${STACKS_DIR}/.env.enc"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

print_header() {
    echo -e "\n${CYAN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}\n"
}

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# ═══════════════════════════════════════════════════════════════════════════════
# INSTALLATION
# ═══════════════════════════════════════════════════════════════════════════════

install_deps() {
    print_header "Installing SOPS and age"
    
    # Install age
    if ! command -v age &>/dev/null; then
        log_info "Installing age..."
        apt-get update -qq
        apt-get install -y age -qq 2>/dev/null || {
            # Manual install if not in repos
            AGE_VERSION="1.1.1"
            wget -q "https://github.com/FiloSottile/age/releases/download/v${AGE_VERSION}/age-v${AGE_VERSION}-linux-amd64.tar.gz" -O /tmp/age.tar.gz
            tar -xzf /tmp/age.tar.gz -C /tmp
            mv /tmp/age/age /usr/local/bin/
            mv /tmp/age/age-keygen /usr/local/bin/
            rm -rf /tmp/age*
        }
        log_success "age installed"
    else
        log_success "age already installed: $(age --version)"
    fi
    
    # Install SOPS
    if ! command -v sops &>/dev/null; then
        log_info "Installing SOPS..."
        SOPS_VERSION="3.8.1"
        wget -q "https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64" -O /usr/local/bin/sops
        chmod +x /usr/local/bin/sops
        log_success "SOPS installed"
    else
        log_success "SOPS already installed: $(sops --version)"
    fi
}

# ═══════════════════════════════════════════════════════════════════════════════
# KEY MANAGEMENT
# ═══════════════════════════════════════════════════════════════════════════════

generate_key() {
    print_header "Generating Age Encryption Key"
    
    mkdir -p "${SECRETS_DIR}"
    chmod 700 "${SECRETS_DIR}"
    
    if [[ -f "${AGE_KEY_FILE}" ]]; then
        log_warn "Age key already exists at ${AGE_KEY_FILE}"
        echo -e "${YELLOW}Do you want to regenerate? This will require re-encrypting all secrets!${NC}"
        read -p "Regenerate key? [y/N]: " confirm
        if [[ "${confirm}" != "y" && "${confirm}" != "Y" ]]; then
            log_info "Keeping existing key"
            return 0
        fi
        cp "${AGE_KEY_FILE}" "${AGE_KEY_FILE}.bak.$(date +%s)"
        log_info "Backed up existing key"
    fi
    
    # Generate new age key
    age-keygen -o "${AGE_KEY_FILE}" 2>&1
    chmod 600 "${AGE_KEY_FILE}"
    
    # Extract public key
    AGE_PUBLIC_KEY=$(grep "public key:" "${AGE_KEY_FILE}" | cut -d: -f2 | tr -d ' ')
    
    log_success "Age key generated"
    echo ""
    echo -e "${GREEN}Public Key:${NC} ${AGE_PUBLIC_KEY}"
    echo ""
    echo -e "${YELLOW}⚠️  IMPORTANT: Backup your private key!${NC}"
    echo -e "   Location: ${AGE_KEY_FILE}"
    echo -e "   Store a copy somewhere safe (password manager, USB drive, etc.)"
    echo ""
    
    # Create SOPS config
    create_sops_config "${AGE_PUBLIC_KEY}"
}

create_sops_config() {
    local public_key="$1"
    
    cat > "${SOPS_CONFIG}" << EOF
# SOPS Configuration for Homelab Secrets
# This file tells SOPS which key to use for encryption

creation_rules:
  # Encrypt .env files
  - path_regex: \.env\.enc$
    age: ${public_key}
  
  # Encrypt secrets YAML files
  - path_regex: secrets\.ya?ml$
    age: ${public_key}
  
  # Encrypt any file in .secrets directory
  - path_regex: \.secrets/.*
    age: ${public_key}
EOF
    
    log_success "SOPS config created at ${SOPS_CONFIG}"
}

show_key() {
    print_header "Age Key Information"
    
    if [[ ! -f "${AGE_KEY_FILE}" ]]; then
        log_error "No age key found. Run: $0 init"
        exit 1
    fi
    
    echo -e "${BLUE}Key File:${NC} ${AGE_KEY_FILE}"
    echo ""
    echo -e "${GREEN}Public Key:${NC}"
    grep "public key:" "${AGE_KEY_FILE}" | cut -d: -f2 | tr -d ' '
    echo ""
    echo -e "${YELLOW}Private Key (first line only):${NC}"
    grep "^AGE-SECRET-KEY" "${AGE_KEY_FILE}" | head -c 30
    echo "..."
}

# ═══════════════════════════════════════════════════════════════════════════════
# ENCRYPTION/DECRYPTION
# ═══════════════════════════════════════════════════════════════════════════════

encrypt_env() {
    print_header "Encrypting .env File"
    
    if [[ ! -f "${AGE_KEY_FILE}" ]]; then
        log_error "No age key found. Run: $0 init"
        exit 1
    fi
    
    if [[ ! -f "${MASTER_ENV}" ]]; then
        log_error "No .env file found at ${MASTER_ENV}"
        exit 1
    fi
    
    export SOPS_AGE_KEY_FILE="${AGE_KEY_FILE}"
    local AGE_PUBLIC_KEY=$(grep "public key:" "${AGE_KEY_FILE}" | cut -d: -f2 | tr -d ' ')
    
    # Encrypt to .env.enc using dotenv format
    sops --encrypt --age "${AGE_PUBLIC_KEY}" --input-type dotenv --output-type dotenv "${MASTER_ENV}" > "${ENCRYPTED_ENV}"
    
    log_success "Encrypted .env to ${ENCRYPTED_ENV}"
    echo ""
    echo -e "${YELLOW}You can now safely commit .env.enc to git${NC}"
    echo -e "Add to .gitignore: ${GREEN}.env${NC} (keep this private)"
    echo -e "Safe to commit: ${GREEN}.env.enc${NC} (encrypted)"
}

decrypt_env() {
    print_header "Decrypting .env File"
    
    if [[ ! -f "${AGE_KEY_FILE}" ]]; then
        log_error "No age key found. Run: $0 init"
        exit 1
    fi
    
    if [[ ! -f "${ENCRYPTED_ENV}" ]]; then
        log_error "No encrypted .env.enc file found"
        exit 1
    fi
    
    export SOPS_AGE_KEY_FILE="${AGE_KEY_FILE}"
    
    # Backup existing .env
    if [[ -f "${MASTER_ENV}" ]]; then
        cp "${MASTER_ENV}" "${MASTER_ENV}.bak"
        log_info "Backed up existing .env"
    fi
    
    # Decrypt using dotenv format
    sops --decrypt --input-type dotenv --output-type dotenv "${ENCRYPTED_ENV}" > "${MASTER_ENV}"
    chmod 600 "${MASTER_ENV}"
    
    log_success "Decrypted to ${MASTER_ENV}"
}

edit_env() {
    print_header "Editing Encrypted .env"
    
    if [[ ! -f "${AGE_KEY_FILE}" ]]; then
        log_error "No age key found. Run: $0 init"
        exit 1
    fi
    
    export SOPS_AGE_KEY_FILE="${AGE_KEY_FILE}"
    
    if [[ -f "${ENCRYPTED_ENV}" ]]; then
        # Edit encrypted file directly (SOPS handles decrypt/encrypt)
        sops "${ENCRYPTED_ENV}"
        # Also update the plaintext version
        sops --decrypt "${ENCRYPTED_ENV}" > "${MASTER_ENV}"
        chmod 600 "${MASTER_ENV}"
        log_success "Updated both .env and .env.enc"
    else
        log_warn "No .env.enc found, editing plaintext .env"
        ${EDITOR:-nano} "${MASTER_ENV}"
        log_info "Run '$0 encrypt' to create encrypted version"
    fi
}

# ═══════════════════════════════════════════════════════════════════════════════
# SECRETS FILE MANAGEMENT
# ═══════════════════════════════════════════════════════════════════════════════

create_secrets_yaml() {
    print_header "Creating Structured Secrets File"
    
    local secrets_file="${SECRETS_DIR}/secrets.yaml"
    
    if [[ -f "${secrets_file}" ]]; then
        log_warn "secrets.yaml already exists"
        return 0
    fi
    
    mkdir -p "${SECRETS_DIR}"
    
    cat > "${secrets_file}" << 'EOF'
# Homelab Secrets Configuration
# This file will be encrypted with SOPS
# Run: secrets-manager.sh encrypt-secrets

# ═══════════════════════════════════════════════════════════════════
# Common Credentials
# ═══════════════════════════════════════════════════════════════════
common:
  username: tammer
  password: "!St00pid!"
  email: imtammer@gmail.com

# ═══════════════════════════════════════════════════════════════════
# Infrastructure
# ═══════════════════════════════════════════════════════════════════
infrastructure:
  proxmox:
    url: https://192.168.0.40:8006
    username: root
    password: "!St00pid!"
  
  truenas:
    url: http://192.168.0.44
    username: truenas_admin
    password: "!St00pid!"
    api_key: ""
  
  ugreen:
    url: http://192.168.0.8:9999
    username: tammer
    password: "!St00pid!"
  
  postgres:
    host: 192.168.0.12
    port: 5432
    username: postgres
    password: postgres

# ═══════════════════════════════════════════════════════════════════
# Reverse Proxy
# ═══════════════════════════════════════════════════════════════════
proxy:
  npmplus:
    url: https://192.168.0.14:81
    username: imtammer@gmail.com
    password: "!St00pid!"
  
  traefik:
    url: https://192.168.0.2
    username: tammer
    password: "!St00pid!"
  
  cloudflare:
    api_token: "changeme"
    zone_id: ""

# ═══════════════════════════════════════════════════════════════════
# Media Services
# ═══════════════════════════════════════════════════════════════════
media:
  plex:
    url: http://192.168.0.13:32400
    claim_token: "changeme"
    api_key: ""
  
  jellyfin:
    url: http://192.168.0.13:8096
    api_key: ""
  
  # Arr Stack API Keys (get from each service's Settings > General)
  sonarr:
    url: http://192.168.0.11:8989
    api_key: ""
  
  radarr:
    url: http://192.168.0.11:7878
    api_key: ""
  
  lidarr:
    url: http://192.168.0.11:8686
    api_key: ""
  
  prowlarr:
    url: http://192.168.0.11:9696
    api_key: ""
  
  readarr:
    url: http://192.168.0.11:8787
    api_key: ""
  
  bazarr:
    url: http://192.168.0.11:6767
    api_key: ""
  
  overseerr:
    url: http://192.168.0.11:5055
    api_key: ""

# ═══════════════════════════════════════════════════════════════════
# Download Clients
# ═══════════════════════════════════════════════════════════════════
downloads:
  sabnzbd:
    url: http://192.168.0.44:8080
    api_key: "j40xqtmq7klebpmlhhz6byrlmtolaad0"
  
  qbittorrent:
    url: http://192.168.0.44:8880
    username: "changeme"
    password: "changeme"

# ═══════════════════════════════════════════════════════════════════
# AI Services
# ═══════════════════════════════════════════════════════════════════
ai:
  ollama:
    url: http://192.168.0.7:11434
  
  openwebui:
    url: http://192.168.0.7:8080
  
  paperless:
    url: http://192.168.0.7:8000
    secret_key: ""
    admin_password: ""

# ═══════════════════════════════════════════════════════════════════
# External APIs
# ═══════════════════════════════════════════════════════════════════
external:
  tmdb:
    api_key: ""
  
  discord:
    bot_token: ""
    client_id: ""
    client_secret: ""
  
  spotify:
    client_id: ""
    client_secret: ""
  
  youtube:
    api_key: ""

EOF
    
    chmod 600 "${secrets_file}"
    log_success "Created secrets template at ${secrets_file}"
    echo ""
    echo -e "${YELLOW}Edit this file with your actual secrets, then run:${NC}"
    echo -e "  $0 encrypt-secrets"
}

encrypt_secrets() {
    local secrets_file="${SECRETS_DIR}/secrets.yaml"
    local encrypted_file="${SECRETS_DIR}/secrets.enc.yaml"
    
    if [[ ! -f "${secrets_file}" ]]; then
        log_error "No secrets.yaml found. Run: $0 create-secrets"
        exit 1
    fi
    
    export SOPS_AGE_KEY_FILE="${AGE_KEY_FILE}"
    
    sops --encrypt "${secrets_file}" > "${encrypted_file}"
    
    # Remove plaintext version
    rm -f "${secrets_file}"
    
    log_success "Encrypted secrets to ${encrypted_file}"
    log_info "Plaintext secrets.yaml has been removed"
}

# ═══════════════════════════════════════════════════════════════════════════════
# DISTRIBUTION
# ═══════════════════════════════════════════════════════════════════════════════

distribute_env() {
    print_header "Distributing .env to Remote Hosts"
    
    local hosts=("mediabox" "ai" "truenas")
    
    for host in "${hosts[@]}"; do
        log_info "Copying .env to ${host}..."
        if scp -q "${MASTER_ENV}" "${host}:/opt/stacks/.env" 2>/dev/null; then
            ssh "${host}" "chmod 600 /opt/stacks/.env" 2>/dev/null
            log_success "${host}: .env updated"
        else
            log_warn "${host}: Failed to copy .env"
        fi
    done
}

# ═══════════════════════════════════════════════════════════════════════════════
# STATUS
# ═══════════════════════════════════════════════════════════════════════════════

status() {
    print_header "Secrets Manager Status"
    
    echo -e "${BLUE}Tools:${NC}"
    echo -n "  age: "
    command -v age &>/dev/null && echo -e "${GREEN}✓ installed${NC}" || echo -e "${RED}✗ not installed${NC}"
    echo -n "  sops: "
    command -v sops &>/dev/null && echo -e "${GREEN}✓ installed${NC}" || echo -e "${RED}✗ not installed${NC}"
    
    echo ""
    echo -e "${BLUE}Files:${NC}"
    echo -n "  Age key: "
    [[ -f "${AGE_KEY_FILE}" ]] && echo -e "${GREEN}✓ ${AGE_KEY_FILE}${NC}" || echo -e "${YELLOW}✗ not generated${NC}"
    echo -n "  SOPS config: "
    [[ -f "${SOPS_CONFIG}" ]] && echo -e "${GREEN}✓ ${SOPS_CONFIG}${NC}" || echo -e "${YELLOW}✗ not created${NC}"
    echo -n "  .env: "
    [[ -f "${MASTER_ENV}" ]] && echo -e "${GREEN}✓ exists ($(wc -l < "${MASTER_ENV}") lines)${NC}" || echo -e "${RED}✗ missing${NC}"
    echo -n "  .env.enc: "
    [[ -f "${ENCRYPTED_ENV}" ]] && echo -e "${GREEN}✓ encrypted${NC}" || echo -e "${YELLOW}✗ not encrypted${NC}"
    
    echo ""
    echo -e "${BLUE}Security:${NC}"
    if [[ -f "${MASTER_ENV}" ]]; then
        local perms=$(stat -c %a "${MASTER_ENV}" 2>/dev/null || stat -f %A "${MASTER_ENV}")
        if [[ "${perms}" == "600" ]]; then
            echo -e "  .env permissions: ${GREEN}✓ 600 (secure)${NC}"
        else
            echo -e "  .env permissions: ${YELLOW}⚠ ${perms} (should be 600)${NC}"
        fi
    fi
    
    if grep -q "^\.env$" "${STACKS_DIR}/.gitignore" 2>/dev/null; then
        echo -e "  .gitignore: ${GREEN}✓ .env is ignored${NC}"
    else
        echo -e "  .gitignore: ${YELLOW}⚠ .env may not be ignored${NC}"
    fi
}

# ═══════════════════════════════════════════════════════════════════════════════
# USAGE
# ═══════════════════════════════════════════════════════════════════════════════

usage() {
    cat << EOF
${CYAN}Homelab Secrets Manager${NC}
Encrypt and manage secrets using SOPS + age

${YELLOW}Usage:${NC} $0 <command>

${BLUE}Setup Commands:${NC}
  install         Install SOPS and age tools
  init            Generate age key and SOPS config
  status          Show current status

${BLUE}Encryption Commands:${NC}
  encrypt         Encrypt .env to .env.enc
  decrypt         Decrypt .env.enc to .env
  edit            Edit encrypted .env (auto encrypt/decrypt)

${BLUE}Secrets File Commands:${NC}
  create-secrets  Create structured secrets.yaml template
  encrypt-secrets Encrypt secrets.yaml

${BLUE}Distribution Commands:${NC}
  distribute      Copy .env to remote hosts
  show-key        Display age public key

${YELLOW}Quick Start:${NC}
  1. $0 install        # Install tools
  2. $0 init           # Generate encryption key
  3. $0 encrypt        # Encrypt your .env file
  4. $0 distribute     # Copy to remote hosts

${YELLOW}Workflow:${NC}
  - Edit secrets:   $0 edit
  - After changes:  $0 encrypt && $0 distribute
  - New host:       $0 decrypt (requires age key)

EOF
}

# ═══════════════════════════════════════════════════════════════════════════════
# MAIN
# ═══════════════════════════════════════════════════════════════════════════════

main() {
    case "${1:-}" in
        install)
            install_deps
            ;;
        init)
            install_deps
            generate_key
            status
            ;;
        encrypt)
            encrypt_env
            ;;
        decrypt)
            decrypt_env
            ;;
        edit)
            edit_env
            ;;
        create-secrets)
            create_secrets_yaml
            ;;
        encrypt-secrets)
            encrypt_secrets
            ;;
        distribute)
            distribute_env
            ;;
        show-key|key)
            show_key
            ;;
        status)
            status
            ;;
        help|--help|-h|"")
            usage
            ;;
        *)
            log_error "Unknown command: $1"
            usage
            exit 1
            ;;
    esac
}

main "$@"
